<script>
  
const currentUrl = window.location.href;

if (currentUrl.includes('/moodle/course/view.php')) {
  const courseId = currentUrl.split('id=')[1];
  const pointsUrl = `/moodle/grade/report/user/index.php?id=${courseId}`;

  fetch(pointsUrl)
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const htmlDoc = parser.parseFromString(html, 'text/html');
      const grades = htmlDoc.querySelectorAll('.column-grade');
      const percentage = htmlDoc.querySelectorAll('.column-percentage');
      const values = getValues(grades);

      const points = values.points;
      console.log(points);

      const amount = values.amount;
      console.log(amount);

      const potency = points / grades.length;
      console.log(potency);

      const maxCoins = 8;
      let coins = 0;
      for (let i = 0; i < amount; i++) {
        coins += Math.round(Math.sin(i) * maxCoins + 1.2 * potency / 100 * maxCoins);
        console.log(coins);
      }
      console.log(coins);

    });
}

function getValues(grades) {
  let points = 0;
  let amount = 0;
  for (let grade of grades) {
    const gradeValue = parseFloat(grade.textContent.replace(',', '.'));
    if (!isNaN(gradeValue) && gradeValue >= 0) {
      points += gradeValue;
      amount += 1;
    }
  }
  return {points, amount};
}

</script>
